// Project: COMP1511 Assignment 1// Brief: C Program that outputs a prediction of a number for the command line argument input of an image filename// Author: Da Jason Sun (z5059224) // Contact details: jason.sun@student.unsw.edu.au// Date: 30/04/2017// Notes: This file also contains training and testing functions for the digit predictions#include <stdio.h>#include <stdlib.h>#include <math.h>#include "captcha.h"void train_neural_network (layer *l);void test_neural_network (layer *l);int main (int argc, char *argv[]) {    int height, width, start_row, start_column, box_width, box_height;    int i;    int prediction = 0;    int centred_pixels[NN_HEIGHT][NN_WIDTH] = {{0}};    layer layer1;        // Train/test functions to determine weights and test accuracy of predictions    // train_neural_network (&layer1);    // test_neural_network (&layer1);    // Initialises neural network layer and initialises weights to previously trained values        get_initialised_layer (&layer1);    get_trained_weights (&layer1);        // Produce error message if no image is called on command line    // Taken from the testing files from lab exercise 7    if (argc < 2) {        fprintf(stderr, "Usage: %s <image-file>\n", argv[0]);        return 1;    }    // Exits program if unable to get pbm dimensions from image    // Taken from the testing files from lab exercise 7    if (get_pbm_dimensions (argv[1], &height, &width) != 1) {        return 1;    }    // Declares pixels after height and width are known for array size    int pixels[height][width];        // Reads input and determines prediction through centring bounding box and determining the highest neuron output    // Reads input    if (read_pbm(argv[1], height, width, pixels) == 1) {        // Centres bounding box of inputted digit        get_centred_digit (height, width, pixels, centred_pixels);        // Loops through all 10 neurons for input and then output        for (int j = 0; j < N_SINGLE_DIGITS; j ++) {            get_neuron_input (&layer1.neuron[j], NN_HEIGHT, NN_WIDTH, centred_pixels);            get_neuron_output (&layer1.neuron[j]);        }        // Determines prediction from highest value output out of all 10 neurons        prediction = get_prediction (&layer1);        printf ("%d\n", prediction);    }    return EXIT_SUCCESS;}// Trains neural network through looping through the training functions that undergo supervised learningvoid train_neural_network (layer *l) {    char fileName[FILENAME_STRING_LENGTH] = {0};    int fileLabel = 0;    double neuronError = 0;    int height, width;    int prediction = 0;    int nSuccess = 0;    int centred_pixels[NN_HEIGHT][NN_WIDTH] = {{0}};    output_format targetOutput;    // Opening file with training file names and file labels    FILE *digitFileNames = fopen ("digits_file_names.c", "r");    FILE *digitFileLabels = fopen ("digits_file_labels.c", "r");    FILE *trainedWeights = fopen ("trained_weights.c", "w");    // Initialise the neural network    get_initialised_layer (l);    for (int i = 0; i < N_TRAINING_FILES; i ++) {        // Reading file names and file labels        fscanf (digitFileNames, "%s", fileName);        fscanf (digitFileLabels, "%d", &fileLabel);        // Sets file label in output format that can be interpreted by the neural network        targetOutput = get_target_output (fileLabel);        // Determines pbm dimensions before declaring pixels for the known height and width array size        get_pbm_dimensions (fileName, &height, &width);        int pixels[height][width];        // Reads input        read_pbm (fileName, height, width, pixels);        // Centres bounding box of inputted digit        get_centred_digit (height, width, pixels, centred_pixels);                // Training neural network throuhg looping through each neuron and determining input, output,         // neuron error and then updating neuron weights given the neuron error        for (int j = 0; j < N_SINGLE_DIGITS; j ++) {            get_neuron_input (&l->neuron[j], NN_HEIGHT, NN_WIDTH, centred_pixels);            get_neuron_output (&l->neuron[j]);            neuronError = get_neuron_error (&l->neuron[j], targetOutput.outputValue[j]);            update_neuron_weights (&l->neuron[j], neuronError);        }    }    // Hardcoding the trained weights    fprintf (trainedWeights, "// Project: COMP1511 Assignment 1\n");    fprintf (trainedWeights, "// Brief: C file that contains function that initialises the current layer's weights with the weights developed from training the neural network\n");    fprintf (trainedWeights, "// Author: Da Jason Sun (z5059224) \n");    fprintf (trainedWeights, "// Contact details: jason.sun@student.unsw.edu.au\n");    fprintf (trainedWeights, "// Date: 30/04/2017\n");    fprintf (trainedWeights, "// Notes:\n\n\n\n");    fprintf (trainedWeights, "#include <stdio.h>\n");    fprintf (trainedWeights, "#include <stdlib.h>\n");    fprintf (trainedWeights, "#include <math.h>\n\n");    fprintf (trainedWeights, "#include \"captcha.h\"\n\n");    fprintf (trainedWeights, "// Updates the current layer's weights with the trained weights\n");    fprintf (trainedWeights, "void get_trained_weights (layer *l) {\n");    for (int i = 0; i < N_SINGLE_DIGITS; i ++) {        for (int y = 0; y < NN_HEIGHT; y ++) {            for (int x = 0; x < NN_WIDTH; x ++) {                fprintf (trainedWeights, "\tl->neuron[%d].weight[%d][%d] = %lf;\n", i, y, x, l->neuron[i].weight[y][x]);            }        }    }    fprintf (trainedWeights, "}\n");    // Closing opened files    fclose (digitFileNames);    fclose (digitFileLabels);    fclose (trainedWeights);}// Tests neural network on digits to test accuracy of predictionsvoid test_neural_network (layer *l) {    char fileName[FILENAME_STRING_LENGTH] = {0};    int fileLabel = 0;    double neuronError = 0;    int height, width;    int prediction = 0;    int nSuccess = 0;    int centred_pixels[NN_HEIGHT][NN_WIDTH] = {{0}};    output_format targetOutput;        // Opening file with training file names and file labels    FILE *digitFileNames = fopen ("test_digits_file_names.c", "r");    FILE *digitFileLabels = fopen ("test_digits_file_labels.c", "r");    FILE *trainedWeights = fopen ("trained_weights.c", "r");    // Initialising the weights to the already trained values    get_initialised_layer (l);    get_trained_weights (l);    // Running through testing files    for (int i = 0; i < N_TESTING_FILES; i ++) {        // Reading file names and file labels        fscanf (digitFileNames, "%s", fileName);        fscanf (digitFileLabels, "%d", &fileLabel);        // Sets file label in output format that can be interpreted by the neural network        targetOutput = get_target_output (fileLabel);        // Determines pbm dimensions before declaring pixels for the known height and width array size        get_pbm_dimensions (fileName, &height, &width);        int pixels[height][width];        // Reads input        read_pbm (fileName, height, width, pixels);        // Centres bounding box of inputted digit        get_centred_digit (height, width, pixels, centred_pixels);        // Tests predictions by looping through all 10 neurons for input and then output        for (int j = 0; j < N_SINGLE_DIGITS; j ++) {            get_neuron_input (&l->neuron[j], NN_HEIGHT, NN_WIDTH, centred_pixels);            get_neuron_output (&l->neuron[j]);        }        // Calculating and displaying aggregate resutls through multiple tests        prediction = get_prediction (l);        if (prediction == fileLabel) {            nSuccess ++;        }        printf ("%s\n", fileName);        printf ("prediction = %d, fileLabel = %d\n", prediction, fileLabel);        printf ("Success rate = %lf\n\n", nSuccess / (double) (i + 1));    }    // Closing opened files    fclose (digitFileNames);    fclose (digitFileLabels);    fclose (trainedWeights);}